## 网络基础概念归纳

> 参考 https://mp.weixin.qq.com/s/W94ZUxGQHGDqBwIXHHD6jA

### 因特网协议栈

![internet protocol stack](https://github.com/bearnew/picture/blob/master/mardown/2019-05-05%20network/protocol.jpg?raw=true)

##### 1. 应用层

- 通过应用进程间的交互来完成特定网络应用
- DNS(domain Name System)
  - 将域名和 IP 地址相互映射的一个分布式数据库,让人们不用记 IP，更方便的访问数据库
- HTTP(HyperText Transfer Protocol)
  - 互联网上引用最广泛的网络协议
  - 所有 WWW(万维网)都必须遵循这个标准

##### 2. 传输层

- 为两个主机应用的进程提供通用的数据传输服务
- TCP(Transmission Control Protocol 传输控制协议)
  - 面向连接
  - 每一条 TCP 连接只能有 2 个端点，每一条 TCP 连接只能 1 对 1
  - 提供可靠（无差错、不丢失、不重复、按序到达）的交互服务
  - 全双工通信
  - 面向字节流,TCP 中的流指流入进程或进程流出的字节序列
- UDP(User Datagram Protocol 用户数据协议)
  - UDP 是无连接的
  - 不保证可靠交互
  - 面向报文
  - UDP 没有拥塞控制，网络出现拥塞不会使源主机的发送速率降低(对直播、实时视频会议等很有用)
  - UDP 支持一对一，一对多，多对一，多对多的交互通信
  - UDP 首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短
- 通信方式
  - 单工数据传输只支持数据在一个方向上传输
  - 半双工数据传输是可以切换方向的单工通信
  - 全双工数据通信是两个半双工数据传输的结合，允许数据在两个方向上传输，发送设备和接受设备都有独立的接收和发送能力

##### 3.网络层

- 发送数据时，网络层把传输层产生的报文段或用户数据报封装成分组和包进行传送
- IP(Internet Protocol Address)

##### 4.数据链路层

- 数据链路层将网络层接收下来的 IP 数据报组装成帧，在两个相邻节点间的链路上传送帧

##### 5.物理层

- 实现相邻计算机节点之间比特流的透明传送

### HTTP 和 HTTPS

##### 1.HTTP（HyperText Transfer Protocol: 超文本传输协议）

用于分布式、协作式、超媒体信息系统的应用层协议, 用于在 web 浏览器和网站服务器之间传递信息

##### 2.HTTPS（HyperText Transfer Protocol Secure: 超文本传输安全协议）

HTTPS 由 http 进行通信，但利用 SSL/TLS 来加密数据包

##### 3.HTTPS 通信过程

1. TCP 三次同步握手
2. 客户端验证服务器数字证书
3. DH 算法协商对称加密算法的密钥、hash 算法的密钥
4. SSL 安全加密隧道协商完成
5. 网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性；用协商的 hash 算法进行数据完整性的保护，保证数据不被篡改

##### 4.区别

|   区别   |                                 HTTP                                 |                                                                                      HTTPS                                                                                       |
| :------: | :------------------------------------------------------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
|   协议   |         运行在 TCP 上，明文传输，数据都是未加密的，安全性差          |                                                         运行在 SSL 上，SSL 运行在 TCP 上，是添加了加密和认证机制的 HTTP                                                          |
|   端口   |                                  80                                  |                                                                                       443                                                                                        |
| 资源消耗 | HTTP 使用 TCP 三次握手建立连接，客户端和服务端交互 3 个包,响应速度快 |                                                  HTTPS 除了 TCP 的 3 个包，还需要加上 SSL 握手的 9 个包，共 12 个包,响应速度慢                                                   |
|   开销   |                               无需证书                               | HTTPS 协议需要的证书，可以到 CA（Certificate Authority，数字证书认证机构）申请证书， 也可以自己制作。<br/>申请的证书无需客户端验证，自己制作的证书需要客户端验证通过才能继续访问 |
| 加密机制 |                               无需加密                               |                                                                              非对称加密 + 对称加密                                                                               |
|  安全性  |                                  弱                                  |                                                                                        强                                                                                        |

##### 5.对称加密

- 加解密使用的同一串密钥
- 对称加密只有一个密钥作为私钥
- 常见的对称加密算法: DES, AES 等

##### 6.非对称加密

- 加解密使用不同的密钥，一个公钥，一个私钥
- 公钥加密的只有私钥才能解密
- 私钥加密的只有公钥才能解密
- 常见的非对称加密算法: RSA

##### 7.数字证书

- 数字证书的包含内容
  - 签发者
  - 证书用途
  - 公钥
  - 加密算法
  - Hash 算法
  - 证书到期时间

##### 8.数字签名

- 服务器将 server 的信息、证书的信息、公钥等 hash 成一个 128 位的 hash 值
- 再用私钥进行加密, 生成数字签名

##### 9.HTTPS 的通信过程

- 通信原理
  - 确认加密算法的过程使用的是非对称性加密
  - 数据传输过程使用的是对称性加密(非对称加密能保证数据的安全性，但速度较慢)
- 通信过程
  1. 服务器将携带的公钥向 CA 申请证书
  2. 数字证书机构颁发证书，返回服务器
  3. 服务器生成一个数字签名
  4. 服务器将证书和数字签名发给客户端
  5. 客户端验证证书，证书机构通过验证，或用户接受非权威机构颁发的证书，获取公钥
  6. 客户端用公钥解密数字签名，与自己计算的 Hash 进行对比,如果 2 者一致，则证明安全，继续通信
  7. 客户端使用公钥加密报文发送给服务器，其中携带随机串，其中的随机串用户传输数据时进行对称加密
  8. 服务器使用私钥解密，获取报文信息及随机串
  9. 解密后服务器发送握手信息给客户端,之后 client 和 server 通信，就使用随机值进行加密和解密了
  10. 客户端接收到握手信息，握手结束，双发确认加密算法（使用随机串确定的对称性加密），开始传输
  11. 服务器使用随机串加密信息传给客户端
  12. 客户端使用随机串进行解密信息

##### 10.HTTP2

- http1 中浏览器限制了同一域名下的请求数量（chrome 下是 6 个）
- http2 引入了多路复用技术，一个 TCP 可以传输所有的请求数据，绕过了浏览器同一域名请求数量限制的问题

### IP/MAC

- 五类 IP 地址
  - A 类 政府机关 1.0.0.1—126.155.255.254
  - B 类 中等规模公司 128.0.0.1—191.255.255.254
  - C 类 私有地址 192.0.0.1—223.255.255.254
  - D 类 广播地址 224.0.0.1—239.255.255.254
  - E 类 用于实验 240.0.0.1—255.255.255.254
- IP 地址，节点被分配到的地址
- MAC 地址，网卡所属的固定地址
- 使用 ARP 协议凭借 MAC 地址进行通信
  - IP 间的通信依赖 MAC 地址
  - ARP 是一种解释地址协议，可以根据 IP 地址反查出 MAC 地址

### TCP 保证传输的可靠性

1. 数据包校验: 若校验包出错，则丢弃报文并不给出响应，TCP 发送数据端超时后会重发数据
2. 对失序包重排序
3. 丢弃重复数据
4. 应答机制：当 TCP 收到 TCP 连接另一端的数据，会发送一个确认
5. 超时重发
6. 流量控制

### TCP3 次握手，4 次挥手

### DNS

- DNS 解析过程
  - 浏览器搜索自己的 DNS 缓存，没有命中，则进入下一步
  - 搜索操作系统的 DNS 缓存，没有命中，则进入下一步
  - 搜索操作系统的 Hosts 文件，没有命中，则进入下一步
  - 发送域名到 LDNS（本地区域名服务器），查询 DNS 缓存，没有命中，则进入下一步
  - LDNS 向 Root Name Server 根域名服务器（com、net、im 等顶级域名服务器）发起请求, 根域名服务器返回顶级域名服务器地址
  - LDNS 向顶级域名服务器发起请求，得到域名服务器地址
  - LDNS 向域名服务器发起请求，得到 IP 地址
  - LDNS 将 IP 返回给操作系统，同时将 IP 缓存起来，操作系统将 IP 地址返回给浏览器，同时将 IP 缓存起来
- DNS 优化
  - 减少 DNS 请求次数
  - 进行 DNS 预获取, DNS Prefetch
- 域名服务器可以配置`CNAME`和`A`记录
  - 将 www.example.com 解析到 IP 地址为 192.0.2.1 的主机上，您需要在域名服务器上设置一个 A 记录，将 www.example.com 映射到 192.0.2.1。
  - 将 blog.example.com 解析到 www.example.com 上，您需要在域名服务器上设置一个 CNAME 记录，将 blog.example.com 映射到 www.example.com

### CDN（content delivery network）

- 构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络阻塞，提高用户访问响应速度和命中率
- CDN 的核心
  - 缓存
  - 回源（十分钟回源更新一次）
- cookie 紧跟域名请求，为了减少不必要的开销，将主站和静态资源置于不同的域名下
