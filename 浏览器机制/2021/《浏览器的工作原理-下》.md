# 浏览器的工作原理-下

## 1. Chrome 开发者工具

1. 开发者工具

- ![开发者工具](https://github.com/bearnew/picture/blob/master/markdown_v2/2021/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/chrome_dev.PNG?raw=true)

2. 网络面板

- ![网络面板](https://github.com/bearnew/picture/blob/master/markdown_v2/2021/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/chrome%E7%BD%91%E7%BB%9C%E9%9D%A2%E6%9D%BF.PNG?raw=true)
- ![控制器](https://github.com/bearnew/picture/blob/master/markdown_v2/2021/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/chrome%E6%8E%A7%E5%88%B6%E5%99%A8.PNG?raw=true)

3. 下载信息

   1. `DOMContentLoaded`，这个事件发⽣后，说明⻚⾯已经构建好 DOM 了，这意味着构建 DOM 所需要的 HTML ⽂件、JavaScript ⽂件、CSS ⽂件都已经下载完成了。
   2. `Load`，说明浏览器已经加载了所有的资源（图像、样式表等）。

4. 单个资源时间线
   1. 单个资源时间线
      - ![时间线](https://github.com/bearnew/picture/blob/master/markdown_v2/2021/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/chrome%E5%8D%95%E4%B8%AA%E6%96%87%E4%BB%B6%E6%97%B6%E9%97%B4%E7%BA%BF.PNG?raw=true)
   2. `Queuing`
      - ⾸先，⻚⾯中的资源是有优先级的，⽐如 CSS、HTML、JavaScript 等都是⻚⾯中的核⼼⽂件，所以优先级最⾼；⽽图⽚、视频、⾳频这类资源就不是核⼼资源，优先级就⽐较低。通常当后者遇到前者时，就需要“让路”，进⼊待排队状态。
      - 其次，我们前⾯也提到过，浏览器会为每个域名最多维护 6 个 TCP 连接，如果发起⼀个 HTTP 请求时，这 6 个 TCP 连接都处于忙碌状态，那么这个请求就会处于排队状态。
      - 最后，⽹络进程在为数据分配磁盘空间时，新的 HTTP 请求也需要短暂地等待磁盘分配结束。
   3. `Stalled`
      - 连接过程被推迟
      - 和服务器建⽴连接的阶段，这包括了建⽴ TCP 连接所花费的时间；不过如果你使⽤了 HTTPS 协议，那么还需要⼀个额外的 SSL 握⼿时间，
   4. 第⼀字节时间（`TTFB`）时间过久
      - 服务器⽣成⻚⾯数据的时间过久
      - ⽹络的原因
      - 发送请求头时带上了多余的⽤⼾信息
      - 解决方法
        1. 去提⾼服务器的处理速度，⽐如通过增加各种缓存的技术
        2. 以使⽤ CDN 来缓存⼀些静态⽂件
        3. 去尽可能地减少⼀些不必要的 Cookie 数据信息

## 2-DOM 树：JavaScript 是如何影响 DOM 树构建的？

1. DOM
   - `DOM` 提供了对 HTML ⽂档结构化的表述。
   - 从⻚⾯的视⻆来看，`DOM` 是⽣成⻚⾯的基础数据结构。
   - 从 `JavaScript` 脚本视⻆来看，`DOM` 提供给 `JavaScript` 脚本操作的接⼝，通过这套接⼝，`JavaScript` 可以对 `DOM` 结构进⾏访问，从⽽改变⽂档的结构、样式和内容。
   - 从安全视⻆来看，`DOM` 是⼀道安全防护线，⼀些不安全的内容在 `DOM` 解析阶段就被拒之⻔外了。
2. DOM 树如何生成
   - HTML 解析器（HTMLParser）, 负责将 HTML 字节流转换为 DOM 结构。
   - HTML 解析器开始⼯作时，会默认创建了⼀个根为 document 的空 DOM 结构
   - ![字节流转 DOM](https://github.com/bearnew/picture/blob/master/markdown_v2/2021/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/%E5%AD%97%E8%8A%82%E6%B5%81%E8%BD%ACDOM.PNG?raw=true)
   - ![字节流生成的 token](https://github.com/bearnew/picture/blob/master/markdown_v2/2021/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/%E5%AD%97%E8%8A%82%E6%B5%81%E7%94%9F%E6%88%90%E7%9A%84token.PNG?raw=true)
3. JavaScript 是如何影响 DOM ⽣成的
   - 解析到`<script>`标签时，渲染引擎判断这是⼀段脚本，此时 HTML 解析器就会暂停 DOM 的解析，因为接下来的 JavaScript 可能要修改当前已经⽣成的 DOM 结构。
   - 脚本执⾏完成之后，HTML 解析器恢复解析过程，继续解析后续的内容，直⾄⽣成最终的 DOM
   - JavaScript ⽂件的下载过程会阻塞 DOM 解析
   - Chrome 浏览器做了很多优化，其中⼀个主要的优化是预解析操作,当渲染引擎收到字节流之后，会开启⼀个预解析线程，⽤来分析 HTML ⽂件中包含的 JavaScript、CSS 等相关⽂件，解析到相关⽂件之后，预解析线程会提前下载这些⽂件。
   - 如果 JavaScript ⽂件中没有操作 DOM 相关代码，就可以将该 JavaScript 脚本设置为异步加载，通过 async 或 defer 来标记代码
   - 使⽤ async 标志的脚本⽂件⼀旦加载完成，会⽴即执⾏；
   - ⽽使⽤了 defer 标记的脚本⽂件，需要等到 DOMContentLoaded 事件之后执⾏
   - 不知道 JavaScript 是否操纵了 CSSOM 的，在执⾏ JavaScript 之前，还需要等待外部的 CSS ⽂件下载完成，并解析⽣成 CSSOM 对象之后，才能执⾏ JavaScript 脚本。
